name: ðŸš€ Deploy Evolution API Lite with Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.10.0'
  DOCKER_IMAGE_NAME: evolution-api-lite

jobs:
  test:
    name: ðŸ§ª Test Application
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: evolution_test
          POSTGRES_HOST_AUTH_METHOD: trust
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:latest
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: âš™ï¸ Create test environment file
      run: |
        cat > .env << EOF
        DATABASE_PROVIDER=postgresql
        DATABASE_CONNECTION_URI=postgresql://test_user:test_pass@localhost:5432/evolution_test
        CACHE_REDIS_URI=redis://localhost:6379
        SERVER_PORT=8080
        SERVER_TYPE=http
        SERVER_URL=http://localhost:8080
        AUTHENTICATION_API_KEY=test-api-key-12345
        CORS_ORIGIN=["*"]
        CORS_METHODS=["GET","POST","PUT","DELETE"]
        CORS_CREDENTIALS=true
        LOG_LEVEL=["ERROR","WARN","INFO"]
        LOG_COLOR=true
        LOG_BAILEYS=error
        LANGUAGE=es
        PRODUCTION=false
        EOF

    - name: ðŸ”„ Generate Prisma client
      run: npm run db:generate

    - name: ðŸ—„ï¸ Run database migrations
      run: npm run db:deploy

    - name: ðŸ—ï¸ Build application
      run: npm run build

    - name: ðŸ§ª Run tests
      run: npm test || echo "No tests configured - skipping"

    - name: âœ… Test completed
      run: echo "All tests passed successfully!"

  build-and-deploy:
    name: ðŸ³ Build and Deploy Docker
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build application
      run: npm run build

    - name: ðŸ“‹ Create production environment
      run: |
        mkdir -p production
        cp -r dist/ production/
        cp package.json production/
        cp package-lock.json production/
        cp -r prisma/ production/
        cp -r public/ production/
        cp docker-compose.yaml production/
        cp Dockerfile production/
        cp env.example production/.env.example
        
        # Crear archivo .env de producciÃ³n
        cat > production/.env << EOF
        DATABASE_PROVIDER=postgresql
        DATABASE_CONNECTION_URI=${{ secrets.DATABASE_CONNECTION_URI }}
        CACHE_REDIS_URI=${{ secrets.CACHE_REDIS_URI }}
        SERVER_PORT=8080
        SERVER_TYPE=http
        SERVER_URL=${{ secrets.SERVER_URL }}
        AUTHENTICATION_API_KEY=${{ secrets.API_KEY }}
        CORS_ORIGIN=["*"]
        CORS_METHODS=["GET","POST","PUT","DELETE"]
        CORS_CREDENTIALS=true
        LOG_LEVEL=["ERROR","WARN","INFO"]
        LOG_COLOR=true
        LOG_BAILEYS=error
        LANGUAGE=es
        PRODUCTION=true
        EOF

    - name: ðŸ“¦ Create deployment package
      run: |
        tar -czf evolution-api-lite-production.tar.gz production/

    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: ðŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ðŸš€ Iniciando despliegue de Evolution API Lite..."
          
          # Crear directorio de aplicaciÃ³n si no existe
          sudo mkdir -p /opt/evolution-api-lite
          cd /opt/evolution-api-lite
          
          # Detener servicios existentes
          echo "ðŸ›‘ Deteniendo servicios existentes..."
          docker-compose down || true
          
          # Limpiar directorio
          echo "ðŸ§¹ Limpiando directorio..."
          sudo rm -rf production/
          
          # Extraer nuevo build
          echo "ðŸ“¦ Extrayendo nuevo build..."
          sudo tar -xzf evolution-api-lite-production.tar.gz
          
          # Mover archivos a la ubicaciÃ³n correcta
          echo "ðŸ“ Moviendo archivos..."
          sudo mv production/* .
          sudo rmdir production
          
          # Configurar permisos
          echo "ðŸ” Configurando permisos..."
          sudo chown -R $USER:$USER /opt/evolution-api-lite
          sudo chmod +x Docker/scripts/*
          
          # Instalar dependencias de producciÃ³n
          echo "ðŸ“¦ Instalando dependencias..."
          npm ci --only=production
          
          # Generar cliente Prisma
          echo "ðŸ”„ Generando cliente Prisma..."
          npm run db:generate
          
          # Ejecutar migraciones
          echo "ðŸ—„ï¸ Ejecutando migraciones..."
          npm run db:deploy
          
          # Iniciar servicios con Docker Compose
          echo "ðŸ³ Iniciando servicios con Docker Compose..."
          docker-compose up -d
          
          # Verificar que el servicio estÃ© funcionando
          echo "ðŸ” Verificando servicio..."
          sleep 30
          
          # Health check
          if curl -f http://localhost:8080/; then
            echo "âœ… Servicio funcionando correctamente!"
          else
            echo "âŒ Error: El servicio no responde"
            docker-compose logs api
            exit 1
          fi
          
          echo "ðŸŽ‰ Despliegue completado exitosamente!"

    - name: ðŸ” Health check
      run: |
        echo "ðŸ” Realizando health check final..."
        sleep 60
        if curl -f ${{ secrets.SERVER_URL }}/; then
          echo "âœ… Health check exitoso!"
        else
          echo "âŒ Health check fallÃ³"
          exit 1
        fi

    - name: ðŸ“Š Deployment Summary
      run: |
        echo "ðŸŽ‰ Despliegue completado exitosamente!"
        echo "ðŸ“ URL: ${{ secrets.SERVER_URL }}"
        echo "ðŸ³ Docker containers ejecutÃ¡ndose"
        echo "ðŸ—„ï¸ Base de datos: PostgreSQL"
        echo "ðŸ”§ Cache: Redis" 